# Опис CI/CD

## Основні завдання, які вирішуються за допомогою build pipeline.

**1. Обробка змін в каталогах с вихідним кодом мікросервісів.**

Основний процес розробки. При змінах в певних каталогах `src/{project_name}/*` запускаються автоматичні дії:

1. Збирання образу Docker

2. После збирання,образу призначається "службовий" тег, який визначається у змінній `$DEBUG`:

```yaml
   DEBUG_TAG: $CI_REGISTRY/$CI_PROJECT_ROOT_NAMESPACE/$CI_PROJECT_NAME/$IMAGE_NAME:$CI_COMMIT_SHORT_SHA
```

3. Образ с тегом з пункту 2 завантажується в реєстр. Необхідно щоб було зафіксовано артифакт успішного збирання образу, якщо далі буде збій pipeline.
   
4. Завантаження із реєстру образа с тегом `$DEBUG`

5. Надання тегів `  DEV_TAG:` -  тег для розробників, щоб вони завжди могли працювати з останньою версією –  `$CI_REGISTRY/$CI_PROJECT_ROOT_NAMESPACE/$CI_PROJECT_NAME/$IMAGE_NAME:latest`,  тегу `BRANCH_TAG` - `$CI_REGISTRY/$CI_PROJECT_ROOT_NAMESPACE/$CI_PROJECT_NAME/$IMAGE_NAME:$CI_COMMIT_BRANCH` - тег
   гілки з якої відбувається build. Це зроблено з метою ілюстрації. Можна додавати теги по `git-tag`, `release` та ін.
   
5. Завантаження у реєстр образів с тегами з пункту 5

7. Зміна образа, який працює з відповідним `debpoiment` у кластерах `kubernetes`. Наприклад, для тестування, образ змінюється на тег `$DEBUG`.

**2. Мати гнучкі функції по збиранню образів Docker**

Повинна бути профілактика реєстру образів – видалення старих, безпекові тестування та інше. Але інколи для debug або для усунення технічного боргу,  потрібно мати старий образ, або образ якогось git-commit. Може виникнути ситуація, коли потрібно мігрувати в інший приватний реєстр Docker образів. Для цього є функція автоматичного збирання образу якщо в gitc ommint є спеціальний текст. 

Наприклад, щоб зібрати образ для мікросервісу `cartservice` потрібно в тексті опису git commit вказати `cartservice-manual`  . Тоді буде автоматично  збиратись відповідний образ по build workflow з першого розділу.

**3. Мати можливість автоматично робити Kubernetes Deployment у відповідний кластер **

Для всіх сервісів створені deployment в кластер kubernetes, які розташовані в в` ./kubernetes/deploy-{envirinment_name}-{service_name}.yaml`. 

> Тобто файл  Kubernetes Deployment для мікросервісу  `cartservice` для середовища `stage` буде мати назву `deploy-stage-cartservice.yaml`

Якщо ці фйли змінено, то за допомогою образу `bitnamy:kubectl` виконується оновлення deployment, що змінився. Або створюється новий, якщо з\`являється новий файл.
